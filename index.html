<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MeuJus — Quiz</title>
  <meta name="description" content="MeuJus — Quiz minimalista com categorias e temas. Pronto para GitHub Pages." />
  <style>
    :root{
      --bg:#ffffff; --bg-soft:#f6f7f8; --ink:#0f172a; --muted:#6b7280; --accent:#111827;
      --ok:#059669; --bad:#b91c1c; --stroke:#e5e7eb;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
      line-height:1.65; font-size:16px; font-weight:400; letter-spacing:.1px;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .container{ max-width:900px; margin:0 auto; padding:16px 24px }
    header.site{ display:flex; align-items:baseline; justify-content:space-between; gap:16px; padding:8px 0 12px }
    .brand{ font-size:20px; font-weight:700; letter-spacing:.2px; color:var(--accent); cursor:pointer; user-select:none }
    .brand:hover{ text-decoration:underline }
    .state{ font-size:12px; color:var(--muted) }
    section{ padding:26px 0 }

    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; font-weight:500 }
    input,select,button{
      appearance:none; border:1px solid var(--stroke); background:#fff; color:var(--ink);
      border-radius:10px; padding:12px 14px; font-size:16px; font-weight:400;
    }
    input:focus,select:focus,button:focus{ outline:none }
    input:focus-visible,select:focus-visible,button:focus-visible{
      box-shadow:0 0 0 3px rgba(17,24,39,.08); border-color:#cbd5e1;
    }
    select,input{ width:100% }
    .controls{ display:grid; gap:12px; grid-template-columns:1fr }
    @media (min-width:620px){ .controls{ grid-template-columns:1fr 1fr } }

    .actions{ display:flex; gap:12px; padding-top:14px; flex-wrap:wrap }
    .btn{ cursor:pointer; padding:12px 16px; font-size:15px; font-weight:600; border:1px solid var(--stroke); }
    .btn.primary{ background:var(--ink); color:#fff; border-color:var(--ink) }
    .btn.ghost{ background:transparent; border-color:var(--stroke) }

    .progress{ height:4px; background:var(--stroke); border-radius:999px; overflow:hidden; margin:10px 0 16px }
    .progress>span{ display:block; width:0%; height:100%; background:#111827; transition:width .25s ease }

    .statement{
      font-size:17px; font-weight:500; line-height:1.35; margin:22px 0 22px; letter-spacing:.1px;
      background:var(--bg-soft); padding:16px 18px; border-radius:12px;
    }
    .qmeta{font-size:12px;color:var(--muted); font-weight:600; letter-spacing:.3px}
    .qsep{height:1px;background:var(--stroke);margin:10px 0 12px;border-radius:999px}

    .options{ display:grid; gap:14px; margin:6px 0 8px }
    .opt{
      text-align:left; background:transparent; border:1px solid var(--stroke);
      padding:16px 16px; border-radius:12px; font-size:16px; font-weight:400; line-height:1.35
    }
    .opt:hover{ border-color:#cbd5e1 }
    .opt[disabled]{ opacity:.7; cursor:not-allowed }
    .opt.correct{ border-color:rgba(5,150,105,.8); background:#f0fdf4 }
    .opt.wrong{ border-color:rgba(185,28,28,.8); background:#fef2f2 }

    .explain{ background:var(--bg-soft); color:var(--ink); padding:14px 14px; border-radius:10px; font-size:15px; margin-top:12px; line-height:1.65 }

    .muted{ color:var(--muted); font-size:13px }
    .meta{ display:flex; justify-content:space-between; gap:12px; padding-top:10px; color:#9ca3af; font-size:12px; margin-top:16px }

    .intro{ background:var(--bg-soft); border-radius:12px; padding:18px 14px }
    .quiz{ padding-top:6px }
    .results h2{ font-size:20px; font-weight:600; margin:0 0 6px }
    .score{ font-size:30px; font-weight:600 }

    .hide{ display:none }

    @media (min-width:780px){
      .statement{ font-size:18px }
      .options{ gap:16px }
      .opt{ padding:18px 18px }
    }

    /* Toast */
    .toast-wrap{position:fixed;inset:auto 0 16px 0;display:flex;justify-content:center;pointer-events:none;z-index:9999}
    .toast{min-width:200px;max-width:420px;margin:0 12px;padding:10px 12px;border-radius:10px;
      font-size:14px;line-height:1.45;border:1px solid var(--stroke);background:#fff;color:#0f172a;
      box-shadow:0 6px 20px rgba(0,0,0,.08);pointer-events:auto;transition:opacity .18s ease,transform .18s ease}
    .toast.success{border-color:rgba(5,150,105,.5);background:#f0fdf4}
    .toast.info{background:#f9fafb}
    .toast.warn{border-color:#f59e0b;background:#fffbeb}
    .toast.error{border-color:rgba(185,28,28,.6);background:#fef2f2}
  </style>
</head>
<body>
  <div class="container">
    <header class="site">
      <div class="brand" id="appTitle" role="button" tabindex="0" aria-label="Voltar ao início">MeuJus</div>
      <div class="state" id="state">pronto</div>
    </header>

    <section class="intro" id="screenIntro">
      <p class="muted" id="introSubtitle">Escolha uma categoria e um tema para começar ou faça uma busca global.</p>

      <div class="controls">
        <div>
          <label for="selCategory">Categoria</label>
          <select id="selCategory" aria-label="Categoria"></select>
        </div>
        <div>
          <label for="selTheme">Tema</label>
          <select id="selTheme" aria-label="Tema"></select>
        </div>
      </div>

      <div class="actions">
        <button id="btnStart" class="btn primary" type="button">Começar</button>
        <button id="btnResume" class="btn ghost hide" type="button">Continuar anterior</button>
      </div>

      <!-- Busca global por último -->
      <div class="controls" style="margin-top:8px">
        <div>
          <label for="txtGlobal">Buscar em todos os temas</label>
          <input id="txtGlobal" type="search" placeholder="Termo exato em enunciados e opções" />
        </div>
        <div class="actions" style="align-items:end;padding-top:0">
          <button id="btnGlobal" class="btn ghost" type="button">Buscar em todos</button>
        </div>
      </div>
    </section>

    <section class="quiz hide" id="screenQuiz">
      <div class="progress" aria-label="Progresso"><span id="bar"></span></div>

      <!-- Busca intra-quiz -->
      <div class="controls">
        <div>
          <label for="txtSearch">Buscar neste tema</label>
          <input id="txtSearch" type="search" placeholder="Termo exato" />
        </div>
        <div class="actions" style="align-items:end;padding-top:0">
          <button id="btnSearch" class="btn ghost" type="button">Buscar</button>
          <button id="btnClearSearch" class="btn ghost hide" type="button">Limpar filtro</button>
        </div>
      </div>

      <!-- Cabeçalho Categoria | Tema + Enunciado -->
      <div id="questionBox" class="statement">
        <div class="qmeta"><span id="qCat">—</span> | <span id="qTheme">—</span></div>
        <div class="qsep"></div>
        <p id="question" style="margin:0"></p>
      </div>

      <div id="options" class="options" role="listbox"></div>
      <div id="explanation" class="explain hide"></div>
      <div class="actions">
        <button id="btnGoHome" class="btn ghost" type="button">Início</button>
        <button id="btnPrev" class="btn ghost" type="button">Anterior</button>
        <button id="btnNext" class="btn primary" type="button">Próximo</button>
        <button id="btnAI" class="btn ghost hide" type="button" aria-label="Gerar explicação do tema com IA">IA</button>
      </div>
      <div class="meta">
        <span id="footLeft">—</span>
        <span id="footRight">—</span>
      </div>
    </section>

    <section class="results hide" id="screenResult">
      <h2 id="resultTitle">Resultado</h2>
      <div class="score" id="resultScore"></div>
      <p class="muted" id="resultMsg"></p>
      <div class="actions">
        <button id="btnRetry" class="btn ghost" type="button">Refazer</button>
        <button id="btnHome" class="btn primary" type="button">Início</button>
      </div>
    </section>
  </div>

  <script>
    // ===== Config =====
    const CONFIG = { useGitHubIndexer:true, owner:null, repo:null, branch:'main', dataDir:'data' };
    const AUTO_RESUME = true;

    // ===== Toast =====
    const getToastWrap = ()=> {
      let w = document.querySelector('.toast-wrap');
      if(!w){ w=document.createElement('div'); w.className='toast-wrap'; document.body.appendChild(w); }
      return w;
    };
    function toast(msg, type='info', ms=2000){
      const wrap=getToastWrap();
      const el=document.createElement('div');
      el.className=`toast ${type}`;
      el.textContent=msg;
      wrap.appendChild(el);
      const close=()=>{ if(!el.isConnected) return; el.style.opacity='0'; el.style.transform='translateY(6px)'; setTimeout(()=> el.remove(),180); };
      el.addEventListener('click', close);
      setTimeout(close, ms);
    }

    // ===== Seletores =====
    const selCategory=document.getElementById('selCategory');
    const selTheme=document.getElementById('selTheme');
    const btnStart=document.getElementById('btnStart');
    const btnResume=document.getElementById('btnResume');
    const txtGlobal=document.getElementById('txtGlobal');
    const btnGlobal=document.getElementById('btnGlobal');

    const screenIntro=document.getElementById('screenIntro');
    const screenQuiz=document.getElementById('screenQuiz');
    const screenResult=document.getElementById('screenResult');

    const appTitle=document.getElementById('appTitle');
    const state=document.getElementById('state');

    const questionEl=document.getElementById('question');
    const optionsEl=document.getElementById('options');
    const bar=document.getElementById('bar');
    const explainEl=document.getElementById('explanation');
    const btnGoHome=document.getElementById('btnGoHome');
    const btnPrev=document.getElementById('btnPrev');
    const btnNext=document.getElementById('btnNext');
    const btnAI=document.getElementById('btnAI');

    const resultTitle=document.getElementById('resultTitle');
    const resultScore=document.getElementById('resultScore');
    const resultMsg=document.getElementById('resultMsg');
    const btnRetry=document.getElementById('btnRetry');
    const btnHome=document.getElementById('btnHome');

    const footLeft=document.getElementById('footLeft');
    const footRight=document.getElementById('footRight');

    // Cabeçalho Categoria | Tema
    const qCat=document.getElementById('qCat');
    const qTheme=document.getElementById('qTheme');

    // Busca intra-quiz
    const txtSearch=document.getElementById('txtSearch');
    const btnSearch=document.getElementById('btnSearch');
    const btnClearSearch=document.getElementById('btnClearSearch');

    // ===== Labels =====
    const DEFAULT_LABELS={ start:'Começar', next:'Próximo', prev:'Anterior', retry:'Refazer', home:'Início', category:'Categoria', theme:'Tema', result:'Resultado' };
    let LABELS={ ...DEFAULT_LABELS };

    // ===== Estado =====
    let MANIFEST=null, QUIZ=null, ORDER=[], CHOSEN=[], I=0, KEY=null, FILTER=null;

    // ===== Utils =====
    const show=(node,flag)=> node.classList.toggle('hide', !flag);
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
    function lsGet(k,def=null){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch{ return def; } }
    function lsSet(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }

    function readEmbedded(path){ const t=document.querySelector(`script[type="application/json"][data-path="${path}"]`); if(!t) return null; try{ return JSON.parse(t.textContent);}catch{ return null; } }
    function mustUseEmbedded(){ return new URLSearchParams(location.search).get('embedded')==='1'; }
    async function loadJSON(path, fallback=undefined){
      if(!mustUseEmbedded()){
        try{ const res=await fetch(path,{cache:'no-store'}); if(res.ok) return res.json(); }catch{}
      }
      const emb=readEmbedded(path); if(emb!=null) return emb; if(fallback!==undefined) return fallback; return null;
    }

    function isCorrectQuestion(q,pick){
      if(!q) return false;
      const t=q.type||'multiple';
      if(t==='vf') return (pick===!!q.answer);
      return (typeof pick==='number' && pick===q.answer);
    }

    // ===== GitHub indexer =====
    function guessOwnerRepo(){
      if(CONFIG.owner && CONFIG.repo) return {owner:CONFIG.owner, repo:CONFIG.repo};
      const host=location.hostname, path=location.pathname;
      if(host.endsWith('.github.io')){
        const owner=host.split('.github.io')[0];
        const parts=path.split('/').filter(Boolean);
        const repo=parts.length?parts[0]:owner;
        return {owner,repo};
      }
      return {owner:CONFIG.owner, repo:CONFIG.repo};
    }
    function slugToName(slug){
      const base=slug.replace(/\.(json)$/i,'').replace(/[-_]+/g,' ').trim();
      const lower=base.toLocaleLowerCase('pt-BR'); if(!lower) return '';
      return lower.charAt(0).toLocaleUpperCase('pt-BR') + lower.slice(1);
    }
    async function buildManifestFromGitHub(){
      const {owner,repo}=guessOwnerRepo(); if(!owner||!repo) return null;
      const url=`https://api.github.com/repos/${owner}/${repo}/git/trees/${encodeURIComponent(CONFIG.branch)}?recursive=1`;
      try{
        const r=await fetch(url,{headers:{'Accept':'application/vnd.github+json'}}); if(!r.ok) return null;
        const data=await r.json(); if(!data||!Array.isArray(data.tree)) return null;
        const nodes=data.tree.filter(n=> n.type==='blob' && n.path.startsWith(CONFIG.dataDir+'/') && n.path.endsWith('.json'));
        const catMap=new Map();
        for(const node of nodes){
          const parts=node.path.split('/'); if(parts.length<3) continue;
          const catId=parts[1]; const file=parts[parts.length-1]; const themeId=file.replace(/\.json$/i,'');
          const cat=catMap.get(catId)||{id:catId,name:slugToName(catId),themes:[]};
          cat.themes.push({id:themeId,name:slugToName(themeId),path:node.path});
          catMap.set(catId,cat);
        }
        const categories=Array.from(catMap.values())
          .map(c=>({...c,themes:c.themes.sort((a,b)=>a.name.localeCompare(b.name,'pt-BR'))}))
          .sort((a,b)=>a.name.localeCompare(b.name,'pt-BR'));
        if(categories.length===0) return null;
        return { title:'MeuJus', labels:'labels/pt-BR.json', shuffleDefault:{questions:false,options:true}, persistDefault:true, outro:{message:'Obrigado por participar.'}, categories };
      }catch{ return null; }
    }

    // ===== Helpers de nomes para o cabeçalho =====
    function namesByPath(path){
      let catName=QUIZ?.meta?.category||'';
      let themeName=QUIZ?.meta?.theme||'';
      for(const c of (MANIFEST?.categories||[])){
        for(const t of (c.themes||[])){
          if(t.path===path){ catName=c.name||c.id; themeName=t.name||t.id; }
        }
      }
      return {catName, themeName};
    }

    // ===== App =====
    init();
    async function init(){
      if(CONFIG.useGitHubIndexer){
        const dyn=await buildManifestFromGitHub(); if(dyn) MANIFEST=dyn;
      }
      if(!MANIFEST){
        const manifestFallback={ title:'MeuJus', categories:[{id:'intro',name:'Introdução',themes:[{id:'basico',name:'Básico',path:'data/intro/basico.json'}]}], shuffleDefault:{questions:false,options:true}, persistDefault:true, outro:{message:'Obrigado por participar.'} };
        MANIFEST=await loadJSON('data/manifest.json', manifestFallback);
      }

      state.textContent='pronto';
      appTitle.textContent=MANIFEST?.title||'MeuJus';
      try{ if(MANIFEST?.labels) LABELS={...DEFAULT_LABELS, ...(await loadJSON(MANIFEST.labels))}; }catch{}
      applyLabels();

      selCategory.innerHTML='';
      (MANIFEST?.categories||[]).forEach((c,idx)=>{
        const o=document.createElement('option'); o.value=c.id; o.textContent=c.name||c.id; if(idx===0) o.selected=true; selCategory.appendChild(o);
      });
      updateThemes();

      // eventos básicos
      selCategory.addEventListener('change', updateThemes);
      btnStart.addEventListener('click', startQuizFromSelection);
      btnPrev.addEventListener('click', prev);
      btnNext.addEventListener('click', next);
      btnAI.addEventListener('click', openGoogleAI);

      // busca global
      btnGlobal.addEventListener('click', ()=> globalSearchAndOpen(txtGlobal.value||''));
      txtGlobal.addEventListener('keydown', (e)=>{ if(e.key==='Enter') btnGlobal.click(); });

      // busca intra-quiz
      btnSearch.addEventListener('click', ()=> applyFilter(txtSearch.value||''));
      btnClearSearch.addEventListener('click', clearFilter);
      txtSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter') btnSearch.click(); });

      const goHome=()=>{ resetState(); show(screenIntro,true); show(screenQuiz,false); show(screenResult,false); state.textContent='pronto'; };
      btnGoHome.addEventListener('click', goHome);
      btnHome.addEventListener('click', goHome);
      appTitle.addEventListener('click', goHome);
      appTitle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') goHome(); });

      btnRetry.addEventListener('click', ()=> { loadQuiz(KEY?.path, true); toast('Quiz reiniciado','info'); });

      const last=lsGet('quiz:last');
      if(last&&last.path){
        btnResume.classList.remove('hide');
        btnResume.addEventListener('click', async ()=>{ KEY=last; await loadQuiz(last.path, false, true); });
        if(AUTO_RESUME){ KEY=last; await loadQuiz(last.path, false, true); return; }
      }

      window.addEventListener('offline', ()=>toast('Sem conexão. Usando cache local','warn',3000));
      window.addEventListener('online',  ()=>toast('Conexão restabelecida','success',1800));

      setTimeout(runTests,0);
    }

    function applyLabels(){
      document.querySelector('label[for="selCategory"]').textContent=LABELS.category||'Categoria';
      document.querySelector('label[for="selTheme"]').textContent=LABELS.theme||'Tema';
      btnStart.textContent=LABELS.start||'Começar';
      btnPrev.textContent=LABELS.prev||'Anterior';
      btnNext.textContent=LABELS.next||'Próximo';
      document.getElementById('resultTitle').textContent=LABELS.result||'Resultado';
      btnRetry.textContent=LABELS.retry||'Refazer';
      btnHome.textContent=LABELS.home||'Início';
      const h=document.getElementById('btnGoHome'); if(h) h.textContent=LABELS.home||'Início';
    }

    function updateThemes(){
      const catId=selCategory.value;
      const cat=(MANIFEST?.categories||[]).find(c=>c.id===catId)||{themes:[]};
      selTheme.innerHTML='';
      (cat.themes||[]).forEach((t,idx)=>{
        const o=document.createElement('option');
        o.value=t.id;
        o.textContent=(t.name||t.id).toLocaleUpperCase('pt-BR');
        if(idx===0) o.selected=true;
        selTheme.appendChild(o);
      });
    }

    function selectedPath(){
      const catId=selCategory.value;
      const cat=(MANIFEST?.categories||[]).find(c=>c.id===catId);
      const themeId=selTheme.value;
      const theme=(cat?.themes||[]).find(t=>t.id===themeId);
      return theme?.path || (catId&&themeId ? `data/${catId}/${themeId}.json`: null);
    }

    async function startQuizFromSelection(){ const path=selectedPath(); if(!path) return; await loadQuiz(path, true); }

    function resetState(){ QUIZ=null; ORDER=[]; CHOSEN=[]; I=0; KEY=null; FILTER=null; explainEl.classList.add('hide'); btnClearSearch.classList.add('hide'); txtSearch.value=''; }

    // ===== Carregar quiz normal =====
    async function loadQuiz(path, fresh=false, tryRestore=false){
      state.textContent='carregando';
      const qz=await loadJSON(path);
      if(!qz||!Array.isArray(qz.questions)){
        alert('Quiz não encontrado: '+path);
        state.textContent='erro';
        toast('Falha ao carregar o quiz','error',3000);
        return;
      }
      QUIZ=qz; KEY={path, key:`quiz:${path}`};

      // Preenche cabeçalho Categoria | Tema
      const nm=namesByPath(path);
      qCat.textContent=nm.catName||'—';
      qTheme.textContent=nm.themeName||'—';

      try{ if(qz.labels){ LABELS={...LABELS, ...(await loadJSON(qz.labels))}; applyLabels(); } }catch{}

      const total=(qz.questions||[]).length;
      let saved=tryRestore?lsGet(KEY.key):null;

      ORDER=[...Array(total).keys()];
      CHOSEN=new Array(total).fill(null);
      I=0;
      FILTER=null; btnClearSearch.classList.add('hide');

      if(!fresh && saved && saved.quizLen===total){
        if(Array.isArray(saved.order)&&saved.order.length>0) ORDER=saved.order;
        if(Array.isArray(saved.chosen)) CHOSEN=saved.chosen;
        I=clamp(saved.i,0,Math.max(0,ORDER.length-1));
        FILTER=saved.filter||null;
        if(FILTER) btnClearSearch.classList.remove('hide');
      }

      state.textContent='respondendo';
      show(screenIntro,false); show(screenQuiz,true); show(screenResult,false);
      toast('Quiz carregado','info');
      if(!fresh && saved) toast(`Progresso restaurado na questão ${I+1}/${ORDER.length||total}`,'success',2200);
      render();
    }

    // ===== Carregar quiz virtual (busca global) =====
    async function loadVirtualQuiz(quizObj, syntheticPath, fresh=true){
      state.textContent='carregando';
      QUIZ=quizObj;
      KEY={ path:syntheticPath, key:`quiz:${syntheticPath}` };

      // Cabeçalho para virtual
      qCat.textContent=QUIZ?.meta?.category||'—';
      qTheme.textContent=QUIZ?.meta?.theme||'—';

      const total=QUIZ.questions.length;
      let saved=lsGet(KEY.key);

      ORDER=[...Array(total).keys()];
      CHOSEN=new Array(total).fill(null);
      I=0;
      FILTER=null; btnClearSearch.classList.add('hide');

      if(!fresh && saved && saved.quizLen===total){
        if(Array.isArray(saved.order)&&saved.order.length>0) ORDER=saved.order;
        if(Array.isArray(saved.chosen)) CHOSEN=saved.chosen;
        I=clamp(saved.i,0,Math.max(0,ORDER.length-1));
        FILTER=saved.filter||null;
        if(FILTER) btnClearSearch.classList.remove('hide');
      }

      state.textContent='respondendo';
      show(screenIntro,false); show(screenQuiz,true); show(screenResult,false);
      render();
    }

    function current(){ return QUIZ.questions[ ORDER[I] ]; }

    // ===== Persistência =====
    function persist(){
      const persistFlag=QUIZ?.meta?.persist ?? MANIFEST?.persistDefault ?? true;
      if(!persistFlag||!KEY) return;
      lsSet(KEY.key,{ i:I, chosen:CHOSEN, order:ORDER, filter:FILTER, quizLen:QUIZ.questions.length, path:KEY.path, ts:Date.now() });
      lsSet('quiz:last', KEY);
    }

    // ===== Render =====
    function render(){
      const total=QUIZ.questions.length;
      const answered=ORDER.filter(idx=> CHOSEN[idx]!==null).length;
      const denom=ORDER.length||total;
      const progBase=Math.max(1,denom-1);
      bar.style.width=Math.round((I)/progBase*100)+'%';
      footLeft.textContent=`Pergunta ${I+1}/${denom}`;
      footRight.textContent= FILTER ? `${answered}/${denom} respondidas · filtro: "${FILTER.term}" (${denom})` : `${answered}/${denom} respondidas`;

      const q=current();
      questionEl.textContent=q.q;
      optionsEl.innerHTML='';
      explainEl.classList.add('hide');
      show(btnAI,false);

      const type=q.type||'multiple';
      if(type==='vf'){
        renderOptions(['Verdadeiro','Falso'], (idx)=> select(idx===0), [0,1]);
      } else {
        const opts=q.options.map((t,i)=>({t,i}));
        renderOptions(opts.map(o=>o.t), (idx)=> select(opts[idx].i), opts.map(o=>o.i));
      }

      // Livre navegação
      btnPrev.disabled = I===0;
      btnNext.textContent = I < denom-1 ? (LABELS.next||'Próximo') : 'Finalizar';

      if(CHOSEN[ ORDER[I] ]!==null) markLocked();

      persist();
    }

    function renderOptions(texts,onPick,origIdxs=null){
      texts.forEach((txt,idx)=>{
        const b=document.createElement('button');
        b.className='opt'; b.textContent=txt; b.dataset.idx=idx; if(origIdxs) b.dataset.origIdx=String(origIdxs[idx]);
        b.addEventListener('click', ()=> onPick(idx));
        optionsEl.appendChild(b);
      });
    }

    function isLocked(){ return optionsEl.querySelector('.correct, .wrong')!=null; }

    function select(value){
      if(isLocked()) return;
      CHOSEN[ ORDER[I] ]=value;
      toast('Resposta salva','info',1200);
      lockAndExplain(value);
      persist();
    }

    function lockAndExplain(value){
      const q=current(); const type=q.type||'multiple';
      const buttons=Array.from(optionsEl.querySelectorAll('.opt')); buttons.forEach(b=>b.disabled=true);
      let correct=false;
      if(type==='vf'){
        correct=(value===!!q.answer);
        buttons[q.answer?0:1].classList.add('correct');
        const chosenIdx=value?0:1; if(!correct) buttons[chosenIdx]?.classList.add('wrong');
      } else {
        const answerIdx=q.answer;
        buttons.forEach(b=>{ const origIdx=parseInt(b.dataset.origIdx??'-1',10); if(origIdx===answerIdx) b.classList.add('correct'); });
        const chosenBtn=buttons.find(b=>parseInt(b.dataset.origIdx??'-1',10)===value);
        correct=(typeof value==='number' && value===answerIdx);
        if(!correct && chosenBtn) chosenBtn.classList.add('wrong');
      }
      state.textContent=correct?'correto':'incorreto';
      toast(correct?'Correto':'Incorreto', correct?'success':'warn',1500);
      explainEl.textContent=q.explanation||'';
      explainEl.classList.toggle('hide', !q.explanation);
      show(btnAI,true);
    }

    function markLocked(){
      const q=current(); const type=q.type||'multiple'; const val=CHOSEN[ ORDER[I] ]; if(val===null) return;
      if(type==='vf'){
        renderOptions(['Verdadeiro','Falso'],()=>{},[0,1]);
      } else {
        const opts=q.options.map((t,i)=>({t,i}));
        renderOptions(opts.map(o=>o.t), ()=>{}, opts.map(o=>o.i));
      }
      lockAndExplain(val);
    }

    // Navegação livre
    function next(){ if(I<ORDER.length-1){ I++; render(); } else { finish(); } }
    function prev(){ if(I>0){ I--; render(); } }

    function score(){
      let ok=0; const total=QUIZ.questions.length;
      for(let k=0;k<total;k++){
        const q=QUIZ.questions[k]; const v=CHOSEN[k];
        if((q.type||'multiple')==='vf'){ if(v===!!q.answer) ok++; }
        else if(typeof v==='number' && v===q.answer) ok++;
      }
      return {ok,total};
    }

    function finish(){
      const {ok,total}=score();
      const pct=Math.round(ok/Math.max(1,total)*100);
      resultScore.textContent=`${pct}% (${ok}/${total})`;
      resultMsg.textContent=QUIZ.meta?.outroMessage || MANIFEST?.outro?.message || '';
      state.textContent='concluído';
      show(screenQuiz,false); show(screenResult,true);
      toast('Você concluiu o quiz','success',2500);
    }

    function openGoogleAI(){
      const q=current(); if(!q) return;
      const prompt='VProfessor, por favor fundamente a alternativa correta e as incorretas. Enunciado: '+String((q&&q.q)||'')+' | Opções: '+(q&&q.type==='vf'?'Verdadeiro | Falso':(Array.isArray(q&&q.options)?q.options.map(function(t,i){return(i+1)+') '+t;}).join(' | '):''))+' | Alternativa correta: '+(q&&q.type==='vf'?(q&&q.answer?'Verdadeiro':'Falso'):(Array.isArray(q&&q.options)&&typeof q.answer==='number'?q.options[q.answer]:''));
      const url='https://www.google.com/search?udm=50&q='+encodeURIComponent(prompt);
      window.open(url,'_blank','noopener');
    }

    // ===== Busca intra-quiz (filtro local) =====
    function applyFilter(termRaw){
      if(!QUIZ){ toast('Carregue um tema antes','warn'); return; }
      const term=String(termRaw||'').trim();
      if(!term){ toast('Informe um termo','warn'); return; }
      const needle=term.toLocaleLowerCase('pt-BR');
      const hits=[];
      QUIZ.questions.forEach((q,idx)=>{
        const inQ=(q.q||'').toLocaleLowerCase('pt-BR').includes(needle);
        let inOpt=false;
        if(q.type!=='vf' && Array.isArray(q.options)){
          inOpt=q.options.some(o=> String(o||'').toLocaleLowerCase('pt-BR').includes(needle));
        }
        if(inQ||inOpt) hits.push(idx);
      });
      if(hits.length===0){ toast('Nada encontrado','warn'); return; }
      ORDER=hits.slice();
      I=0;
      FILTER={ term, size:hits.length };
      btnClearSearch.classList.remove('hide');
      toast(`Filtro aplicado (${hits.length})`,'info');
      render();
    }

    function clearFilter(){
      if(!QUIZ) return;
      ORDER=[...Array(QUIZ.questions.length).keys()];
      FILTER=null;
      btnClearSearch.classList.add('hide');
      I=0;
      toast('Filtro removido','info');
      render();
    }

    // ===== Busca global na página inicial =====
    async function globalSearchAndOpen(termRaw){
      const term=String(termRaw||'').trim();
      if(!term){ toast('Informe um termo para busca global','warn'); return; }
      const needle=term.toLocaleLowerCase('pt-BR');

      const allPaths=[];
      (MANIFEST?.categories||[]).forEach(c=>{ (c.themes||[]).forEach(t=> allPaths.push(t.path)); });
      if(allPaths.length===0){ toast('Nenhum tema disponível para busca','error'); return; }

      state.textContent='buscando';
      let results=[];
      for(const p of allPaths){
        try{
          const data=await loadJSON(p);
          if(!data||!Array.isArray(data.questions)) continue;
          data.questions.forEach((q,idx)=>{
            const inQ=(q.q||'').toLocaleLowerCase('pt-BR').includes(needle);
            let inOpt=false;
            if(q.type!=='vf' && Array.isArray(q.options)){
              inOpt=q.options.some(o=> String(o||'').toLocaleLowerCase('pt-BR').includes(needle));
            }
            if(inQ||inOpt){
              const clone=JSON.parse(JSON.stringify(q));
              clone.__origin={ path:p, index:idx };
              results.push(clone);
            }
          });
        }catch{}
      }

      if(results.length===0){
        state.textContent='pronto';
        toast('Nada encontrado na busca global','warn',2400);
        return;
      }

      const virtual={
        meta:{ title:`Busca global: "${term}"`, category:'busca', theme:'global', shuffle:{questions:false,options:true}, persist:true, outroMessage:`${results.length} resultados encontrados na busca global.` },
        questions:results
      };
      const synth=`search://global?term=${encodeURIComponent(term)}`;
      await loadVirtualQuiz(virtual, synth, true);
      toast(`Busca global: ${results.length} questões`, 'info', 2200);
    }

    // ===== Acessibilidade =====
    window.addEventListener('keydown',(e)=>{
      if(screenQuiz.classList.contains('hide')) return;
      if(e.key>='1'&&e.key<='9'){
        const idx=parseInt(e.key,10)-1; const btn=optionsEl.querySelectorAll('.opt')[idx]; if(btn) btn.click();
      } else if(e.key==='Enter'||e.key==='ArrowRight'){
        if(I===ORDER.length-1) finish(); else next();
      } else if(e.key==='ArrowLeft'){ prev(); }
    });

    window.addEventListener('beforeunload', persist);
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState: analysis
