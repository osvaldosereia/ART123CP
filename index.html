<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MeuJus — Quiz</title>
  <meta name="description" content="MeuJus — Quiz minimalista com categorias e temas. Agora com parser de TXT e títulos vindos de pasta/arquivo." />
  <style>
    :root{ --bg:#ffffff; --bg-soft:#f6f7f8; --ink:#0f172a; --muted:#6b7280; --accent:#111827; --ok:#059669; --bad:#b91c1c; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
      line-height:1.6; font-size:15px; font-weight:300;
    }

    .container{ max-width:900px; margin:0 auto; padding:12px 24px }
    header.site{ display:flex; align-items:baseline; justify-content:space-between; gap:16px; padding:12px 0 12px }
    .brand{ font-size:18px; font-weight:700; letter-spacing:.2px; color:var(--accent); cursor:pointer; user-select:none }
    .brand:hover{ text-decoration:underline }
    .state{ font-size:12px; color:var(--muted) }
    section{ padding:26px 0 }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px }
    input,select,button{ appearance:none; border:1px solid #e5e7eb; background:#fff; color:var(--ink); border-radius:8px; padding:10px 12px; font-size:14px; font-weight:300 }
    select,input{ width:100% }
    .controls{ display:grid; gap:12px; grid-template-columns:1fr }
    @media (min-width:620px){ .controls{ grid-template-columns:1fr 1fr } }

    .actions{ display:flex; gap:12px; padding-top:14px; flex-wrap:wrap }
    .btn{ cursor:pointer; padding:12px 14px; font-size:14px }
    .btn.primary{ background:var(--ink); color:#fff; border-color:var(--ink) }
    .btn.ghost{ background:transparent; border-color:#e5e7eb }

    .progress{ height:3px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:10px 0 16px }
    .progress>span{ display:block; width:0%; height:100%; background:#111827; transition:width .25s ease }

    .statement{ font-size:16px; font-weight:500; line-height:1.4; margin:22px 0 22px; letter-spacing:.1px; background:var(--bg-soft); padding:14px 16px; border-radius:12px; }
    .statement p{ margin:0 0 10px }
    .options{ display:grid; gap:14px; margin:6px 0 8px }
    .opt{
      text-align:left; background:transparent; border:1px solid #e5e7eb;
      padding:16px 16px; border-radius:12px; font-size:15px; font-weight:300; line-height:1.3
    }
    .opt:hover{ border-color:#cbd5e1 }
    .opt[disabled]{ opacity:.7; cursor:not-allowed }
    .opt.correct{ border-color:rgba(5,150,105,.8); background:#f0fdf4 }
    .opt.wrong{ border-color:rgba(185,28,28,.8); background:#fef2f2 }

    .explain{ background:var(--bg-soft); color:var(--ink); padding:14px 14px; border-radius:10px; font-size:14px; margin-top:12px; line-height:1.6 }

    .muted{ color:var(--muted); font-size:13px }
    .meta{ display:flex; justify-content:space-between; gap:12px; padding-top:10px; color:#9ca3af; font-size:12px; margin-top:16px }

    .intro{ background:var(--bg-soft); border-radius:12px; padding:18px 14px }
    .quiz{ padding-top:6px }
    .results h2{ font-size:18px; font-weight:400; margin:0 0 4px }
    .score{ font-size:28px; font-weight:400 }

    .hide{ display:none }

    @media (min-width:780px){
      .statement{ font-size:16px }
      .options{ gap:16px }
      .opt{ padding:18px 18px }
    }

    /* Toast */
    .toast-wrap{position:fixed;inset:auto 0 16px 0;display:flex;justify-content:center;pointer-events:none;z-index:9999}
    .toast{min-width:200px;max-width:420px;margin:0 12px;padding:10px 12px;border-radius:10px;
      font-size:14px;line-height:1.4;border:1px solid #e5e7eb;background:#fff;color:#0f172a;
      box-shadow:0 6px 20px rgba(0,0,0,.08);pointer-events:auto;transition:opacity .18s ease,transform .18s ease}
    .toast.success{border-color:rgba(5,150,105,.5);background:#f0fdf4}
    .toast.info{background:#f9fafb}
    .toast.warn{border-color:#f59e0b;background:#fffbeb}
    .toast.error{border-color:rgba(185,28,28,.6);background:#fef2f2}
  </style>
</head>
<body>
  <div class="container">
    <header class="site">
      <div class="brand" id="appTitle" role="button" tabindex="0" aria-label="Voltar ao início">MeuJus</div>
      <div class="state" id="state">pronto</div>
    </header>

   <section class="intro" id="screenIntro">
  <p class="muted" id="introSubtitle">Escolha uma categoria e um tema para começar ou faça uma busca global.</p>

  <div class="controls">
    <div>
      <label for="selCategory">Categoria</label>
      <select id="selCategory" aria-label="Categoria"></select>
    </div>
    <div>
      <label for="selTheme">Tema</label>
      <select id="selTheme" aria-label="Tema"></select>
    </div>
  </div>

  <div class="actions">
    <button id="btnStart" class="btn primary" type="button">Começar</button>
    <button id="btnResume" class="btn ghost hide" type="button">Continuar anterior</button>
  </div>

  <!-- Busca global (por último) -->
  <div class="controls" style="margin-top:8px">
    <div>
      <label for="txtGlobal">Buscar em todos os temas</label>
      <input id="txtGlobal" type="search" placeholder="Termo exato em enunciados e opções" />
    </div>
    <div class="actions" style="align-items:end;padding-top:0">
      <button id="btnGlobal" class="btn ghost" type="button">Buscar em todos</button>
    </div>
  </div>
</section>


    <section class="quiz hide" id="screenQuiz">
      <div class="progress" aria-label="Progresso"><span id="bar"></span></div>

      <!-- Busca intra-quiz -->
      <div class="controls">
        <div>
          <label for="txtSearch">Buscar neste tema</label>
          <input id="txtSearch" type="search" placeholder="Termo exato" />
        </div>
        <div class="actions" style="align-items:end;padding-top:0">
          <button id="btnSearch" class="btn ghost" type="button">Buscar</button>
          <button id="btnClearSearch" class="btn ghost hide" type="button">Limpar filtro</button>
        </div>
      </div>

      <div id="question" class="statement"></div>
      <div id="options" class="options" role="listbox"></div>
      <div id="explanation" class="explain hide"></div>
      <div class="actions">
        <button id="btnGoHome" class="btn ghost" type="button">Início</button>
        <button id="btnPrev" class="btn ghost" type="button">Anterior</button>
        <button id="btnNext" class="btn primary" type="button">Próximo</button>
        <button id="btnAI" class="btn ghost hide" type="button" aria-label="Gerar explicação do tema com IA">Comentário com IA</button>
      </div>
      <div class="meta">
        <span id="footLeft">—</span>
        <span id="footRight">—</span>
      </div>
    </section>

    <section class="results hide" id="screenResult">
      <h2 id="resultTitle">Resultado</h2>
      <div class="score" id="resultScore"></div>
      <p class="muted" id="resultMsg"></p>
      <div class="actions">
        <button id="btnRetry" class="btn ghost" type="button">Refazer</button>
        <button id="btnHome" class="btn primary" type="button">Início</button>
      </div>
    </section>
  </div>

  <script>
    // ===== Config =====
    const CONFIG = {
      useGitHubIndexer: true,
      owner: null,
      repo: null,
      branch: 'main',
      dataDir: 'data'
    };
    const AUTO_RESUME = true;

    // ===== Toast =====
    const getToastWrap = ()=> {
      let w = document.querySelector('.toast-wrap');
      if(!w){ w=document.createElement('div'); w.className='toast-wrap'; document.body.appendChild(w); }
      return w;
    };
    function toast(msg, type='info', ms=2000){
      const wrap=getToastWrap();
      const el=document.createElement('div');
      el.className=`toast ${type}`;
      el.textContent=msg;
      wrap.appendChild(el);
      const close=()=>{ if(!el.isConnected) return; el.style.opacity='0'; el.style.transform='translateY(6px)'; setTimeout(()=> el.remove(),180); };
      el.addEventListener('click', close);
      setTimeout(close, ms);
    }

    // ===== Seletores =====
    const selCategory = document.getElementById('selCategory');
    const selTheme = document.getElementById('selTheme');
    const btnStart = document.getElementById('btnStart');
    const btnResume = document.getElementById('btnResume');
    const txtGlobal = document.getElementById('txtGlobal');
    const btnGlobal = document.getElementById('btnGlobal');

    const screenIntro = document.getElementById('screenIntro');
    const screenQuiz = document.getElementById('screenQuiz');
    const screenResult = document.getElementById('screenResult');

    const appTitle = document.getElementById('appTitle');
    const state = document.getElementById('state');

    const questionEl = document.getElementById('question');
    const optionsEl = document.getElementById('options');
    const bar = document.getElementById('bar');
    const explainEl = document.getElementById('explanation');
    const btnGoHome = document.getElementById('btnGoHome');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnAI = document.getElementById('btnAI');

    const resultTitle = document.getElementById('resultTitle');
    const resultScore = document.getElementById('resultScore');
    const resultMsg = document.getElementById('resultMsg');
    const btnRetry = document.getElementById('btnRetry');
    const btnHome = document.getElementById('btnHome');

    const footLeft = document.getElementById('footLeft');
    const footRight = document.getElementById('footRight');

    // Busca intra-quiz
    const txtSearch = document.getElementById('txtSearch');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');

    // ===== Labels =====
    const DEFAULT_LABELS = { start:'Começar', next:'Próximo', prev:'Anterior', retry:'Refazer', home:'Início', category:'Categoria', theme:'Tema', result:'Resultado' };
    let LABELS = { ...DEFAULT_LABELS };

    // ===== Estado =====
    let MANIFEST = null, QUIZ = null, ORDER = [], CHOSEN = [], I = 0, KEY = null, FILTER = null;

    // ===== Utils =====
    const show = (node, flag) => node.classList.toggle('hide', !flag);
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    function lsGet(k, def=null){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch{ return def; } }
    function lsSet(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }

    function readEmbedded(path){ const t=document.querySelector(`script[type="application/json"][data-path="${path}"]`); if(!t) return null; try{ return JSON.parse(t.textContent);}catch{ return null; } }
    function mustUseEmbedded(){ return new URLSearchParams(location.search).get('embedded')==='1'; }

    async function fetchText(path){
      if(!mustUseEmbedded()){
        try{ const res = await fetch(path, {cache:'no-store'}); if(res.ok) return await res.text(); }catch{}
      }
      // fallback inexistente para TXT
      return '';
    }
    async function loadJSON(path, fallback=undefined){
      if(!mustUseEmbedded()){
        try{ const res=await fetch(path,{cache:'no-store'}); if(res.ok) return res.json(); }catch{}
      }
      const emb=readEmbedded(path); if(emb!=null) return emb; if(fallback!==undefined) return fallback; return null;
    }

    function isCorrectQuestion(q, pick){
      if(!q) return false;
      const t=q.type||'multiple';
      if(t==='vf') return (pick===!!q.answer);
      return (typeof pick==='number' && pick===q.answer);
    }

    // ===== Normalização para busca =====
    function normalizeText(str) {
      if (!str) return '';
      return String(str)
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/ç/g, 'c');
    }

    // ===== GitHub indexer (agora .txt) =====
    function guessOwnerRepo(){
      if(CONFIG.owner && CONFIG.repo) return {owner:CONFIG.owner, repo:CONFIG.repo};
      const host = location.hostname;
      const path = location.pathname;
      if(host.endsWith('.github.io')){
        const owner = host.split('.github.io')[0];
        const parts = path.split('/').filter(Boolean);
        const repo = parts.length ? parts[0] : owner;
        return {owner, repo};
      }
      return {owner: CONFIG.owner, repo: CONFIG.repo};
    }

    function toTitleCaseKeep(str){
      // Mantém caixa como vier, só limpa extensão e underscores
      return String(str||'').replace(/\.txt$/i,'').replace(/_/g,'_').trim();
    }

    async function buildManifestFromGitHub(){
      const {owner, repo} = guessOwnerRepo();
      if(!owner || !repo) return null;

      const url = `https://api.github.com/repos/${owner}/${repo}/git/trees/${encodeURIComponent(CONFIG.branch)}?recursive=1`;
      try{
        const r = await fetch(url, {headers:{'Accept':'application/vnd.github+json'}});
        if(!r.ok) return null;
        const data = await r.json();
        if(!data || !Array.isArray(data.tree)) return null;

        const nodes = data.tree.filter(n => n.type==='blob' && n.path.startsWith(CONFIG.dataDir+'/') && n.path.endsWith('.txt'));

        const catMap = new Map();
        for(const node of nodes){
          const parts = node.path.split('/');
          if(parts.length < 3) continue;
          const catId = parts[1]; // nome exato da pasta
          const file = parts[parts.length-1];
          const themeId = file.replace(/\.txt$/i,'');
          const cat = catMap.get(catId) || { id: catId, name: catId, themes: [] };
          cat.themes.push({ id: themeId, name: themeId, path: node.path });
          catMap.set(catId, cat);
        }

        const categories = Array.from(catMap.values()).map(c => ({...c, themes: c.themes.sort((a,b)=> a.name.localeCompare(b.name,'pt-BR'))})).sort((a,b)=> a.name.localeCompare(b.name,'pt-BR'));
        if(categories.length===0) return null;

        return {
          title: 'MeuJus',
          labels: 'labels/pt-BR.json',
          shuffleDefault: {questions:false, options:true},
          persistDefault: true,
          outro: { message: 'Obrigado por participar.' },
          categories
        };
      }catch{
        return null;
      }
    }

    // ===== TXT → QUIZ Parser =====
    function htmlEscape(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    function formatParagraphs(s){
      const clean = String(s||'')
        .replace(/\r\n?/g,'\n')
        .replace(/[\u00A0\t]+/g,' ')
        .replace(/\s+$/gm,'')
        .trim();
      const parts = clean.split(/\n{2,}/).map(t=>t.trim()).filter(Boolean);
      return parts.map(p=>`<p>${htmlEscape(p)}</p>`).join('');
    }

    function parseTxtQuestions(raw){
      const text = String(raw||'')
        .replace(/\uFEFF/g,'') // BOM
        .replace(/\r\n?/g,'\n');

      // corta blocos por linhas de ----- ou fim de arquivo
      const blocks = text.split(/\n-{3,}\n/g).map(b=>b.trim()).filter(Boolean);
      const qs = [];
      for(const block of blocks){
        // pega gabarito
        const gabMatch = block.match(/--\s*Gabarito\s*:\s*([A-E])/i);
        const gab = gabMatch ? gabMatch[1].toUpperCase() : null;

        // pega enunciado após "# " e antes de "- A)"
        const aIdx = block.search(/^\s*-\s*A\)/m);
        const hIdx = block.indexOf('#');
        let head = '';
        if(hIdx >= 0 && aIdx > hIdx){
          head = block.slice(hIdx).replace(/^#\s*/,'').slice(0, aIdx - hIdx).trim();
        }

        // captura opções A-D com limites até a próxima opção ou gabarito
        function grabOpt(letter){
          const reStart = new RegExp(`^\s*-\s*${letter}\\)\s*`, 'm');
          const m = reStart.exec(block);
          if(!m) return '';
          const start = m.index + m[0].length;
          // próxima âncora
          const next = ['A','B','C','D','E'].filter(l=>l!==letter).map(l=>{
            const r = new RegExp(`^\s*-\s*${l}\\)\s*`, 'm');
            const x = r.exec(block); return x?x.index:null;
          }).filter(x=>x!=null).sort((a,b)=>a-b);
          const g = block.search(/\n\s*--\s*Gabarito\b/m);
          if(g>=0) next.push(g);
          const end = next.find(n=>n>start) ?? block.length;
          let slice = block.slice(start, end);
          // remove marcador de citação inline se existir
          slice = slice.replace(/\[cite:[^\]]*\]/gi,'');
          return slice.trim();
        }
        const A = grabOpt('A');
        const B = grabOpt('B');
        const C = grabOpt('C');
        const D = grabOpt('D');
        const options = [A,B,C,D].map(t=>t.replace(/\n{2,}/g,'\n\n'));
        if(!head || options.every(o=>!o)) continue;

        const answerMap = {A:0,B:1,C:2,D:3};
        const answer = gab && answerMap[gab] != null ? answerMap[gab] : 0;
        qs.push({ type:'multiple', q: formatParagraphs(head), options, answer, explanation:'' });
      }
      return qs;
    }

    async function loadTxtAsQuiz(path){
      const raw = await fetchText(path);
      const questions = parseTxtQuestions(raw);
      // meta a partir do caminho: data/<categoria>/<arquivo>.txt
      const parts = path.split('/');
      const category = parts[1] || 'Geral';
      const file = (parts[parts.length-1]||'Quiz.txt').replace(/\.txt$/i,'');
      return {
        meta: {
          title: file,            // nome EXATO do arquivo
          category: category,     // nome EXATO da pasta
          theme: file,
          shuffle: {questions:false, options:true},
          persist: true,
          outroMessage: ''
        },
        questions
      };
    }

    // ===== App =====
    init();
    async function init(){
      if(CONFIG.useGitHubIndexer){
        const dyn = await buildManifestFromGitHub();
        if(dyn) MANIFEST = dyn;
      }

      if(!MANIFEST){
        const manifestFallback={
          title:'MeuJus',
          categories:[{id:'intro',name:'Introdução',themes:[{id:'basico',name:'Básico',path:'data/intro/basico.txt'}]}],
          shuffleDefault:{questions:false,options:true},
          persistDefault:true,
          outro:{message:'Obrigado por participar.'}
        };
        MANIFEST = await loadJSON('data/manifest.json', manifestFallback);
      }

      state.textContent='pronto';
      appTitle.textContent = MANIFEST?.title || 'MeuJus';
      try{ if(MANIFEST?.labels) LABELS={...DEFAULT_LABELS, ...(await loadJSON(MANIFEST.labels))}; }catch{}
      applyLabels();

      selCategory.innerHTML='';
      (MANIFEST?.categories||[]).forEach((c,idx)=>{
        const o=document.createElement('option');
        o.value=c.id;
        o.textContent=c.name||c.id;
        if(idx===0) o.selected=true;
        selCategory.appendChild(o);
      });
      updateThemes();

      // eventos básicos
      selCategory.addEventListener('change', updateThemes);
      btnStart.addEventListener('click', startQuizFromSelection);
      btnPrev.addEventListener('click', prev);
      btnNext.addEventListener('click', next);
      btnAI.addEventListener('click', openGoogleAI);

      // busca global
      btnGlobal.addEventListener('click', ()=> globalSearchAndOpen(txtGlobal.value||''));
      txtGlobal.addEventListener('keydown', (e)=>{ if(e.key==='Enter') btnGlobal.click(); });

      // busca intra-quiz
      btnSearch.addEventListener('click', ()=> applyFilter(txtSearch.value||''));
      btnClearSearch.addEventListener('click', clearFilter);
      txtSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter') btnSearch.click(); });

      const goHome = ()=>{ resetState(); show(screenIntro,true); show(screenQuiz,false); show(screenResult,false); state.textContent='pronto'; };
      btnGoHome.addEventListener('click', goHome);
      btnHome.addEventListener('click', goHome);
      appTitle.addEventListener('click', goHome);
      appTitle.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') goHome(); });

      btnRetry.addEventListener('click', ()=> { loadQuiz(KEY?.path, true); toast('Quiz reiniciado','info'); });

      const last = lsGet('quiz:last');
      if (last && last.path) {
        btnResume.classList.remove('hide');
        btnResume.addEventListener('click', async ()=>{ KEY = last; await loadQuiz(last.path, false, true); });
        if (AUTO_RESUME) { KEY = last; await loadQuiz(last.path, false, true); return; }
      }

      window.addEventListener('offline', ()=>toast('Sem conexão. Usando cache local','warn',3000));
      window.addEventListener('online',  ()=>toast('Conexão restabelecida','success',1800));
    }

    function applyLabels(){
      document.querySelector('label[for="selCategory"]').textContent = LABELS.category||'Categoria';
      document.querySelector('label[for="selTheme"]').textContent = LABELS.theme||'Tema';
      btnStart.textContent = LABELS.start||'Começar';
      btnPrev.textContent = LABELS.prev||'Anterior';
      btnNext.textContent = LABELS.next||'Próximo';
      document.getElementById('resultTitle').textContent = LABELS.result||'Resultado';
      btnRetry.textContent = LABELS.retry||'Refazer';
      btnHome.textContent = LABELS.home||'Início';
      const h = document.getElementById('btnGoHome'); if(h) h.textContent = LABELS.home||'Início';
    }

    function updateThemes(){
      const catId = selCategory.value;
      const cat = (MANIFEST?.categories||[]).find(c=>c.id===catId) || {themes:[]};
      selTheme.innerHTML='';
      (cat.themes||[]).forEach((t,idx)=>{
        const o=document.createElement('option');
        o.value=t.id;
        o.textContent=(t.name||t.id).toLocaleUpperCase('pt-BR');
        if(idx===0) o.selected=true;
        selTheme.appendChild(o);
      });
    }

    function selectedPath(){
      const catId=selCategory.value;
      const cat=(MANIFEST?.categories||[]).find(c=>c.id===catId);
      const themeId=selTheme.value;
      const theme=(cat?.themes||[]).find(t=>t.id===themeId);
      return theme?.path || (catId&&themeId ? `data/${catId}/${themeId}.txt`: null);
    }

    async function startQuizFromSelection(){ const path=selectedPath(); if(!path) return; await loadQuiz(path, true); }

    function resetState(){ QUIZ=null; ORDER=[]; CHOSEN=[]; I=0; KEY=null; FILTER=null; explainEl.classList.add('hide'); btnClearSearch.classList.add('hide'); txtSearch.value=''; }

    // ===== Carregar quiz (TXT) =====
    async function loadQuiz(path, fresh=false, tryRestore=false){
      state.textContent='carregando';
      let qz=null;
      if(/\.txt$/i.test(path)) qz = await loadTxtAsQuiz(path);
      else if(/\.json$/i.test(path)) qz = await loadJSON(path);

      if(!qz || !Array.isArray(qz.questions)){
        alert('Quiz não encontrado: '+path);
        state.textContent='erro';
        toast('Falha ao carregar o quiz','error',3000);
        return;
      }
      QUIZ=qz; KEY={path, key:`quiz:${path}`};

      try{ if(qz.labels){ LABELS={...LABELS, ...(await loadJSON(qz.labels))}; applyLabels(); } }catch{}

      const total=(qz.questions||[]).length;
      let saved = tryRestore ? lsGet(KEY.key) : null;

      ORDER=[...Array(total).keys()];
      CHOSEN=new Array(total).fill(null);
      I=0;
      FILTER=null; btnClearSearch.classList.add('hide');

      if(!fresh && saved && saved.quizLen===total){
        if(Array.isArray(saved.order) && saved.order.length>0) ORDER = saved.order;
        if(Array.isArray(saved.chosen)) CHOSEN = saved.chosen;
        I = clamp(saved.i,0,Math.max(0,ORDER.length-1));
        FILTER = saved.filter || null;
        if(FILTER) btnClearSearch.classList.remove('hide');
      }

      state.textContent='respondendo';
      show(screenIntro,false); show(screenQuiz,true); show(screenResult,false);
      toast('Quiz carregado','info');
      if(!fresh && saved) toast(`Progresso restaurado na questão ${I+1}/${ORDER.length||total}`,'success',2200);
      render();
    }

    // ===== Carregar quiz virtual (resultado da busca global) =====
    async function loadVirtualQuiz(quizObj, syntheticPath, fresh=true){
      state.textContent='carregando';
      QUIZ = quizObj;
      KEY = { path: syntheticPath, key: `quiz:${syntheticPath}` };

      const total = QUIZ.questions.length;
      let saved = lsGet(KEY.key);

      ORDER = [...Array(total).keys()];
      CHOSEN = new Array(total).fill(null);
      I = 0;
      FILTER = null; btnClearSearch.classList.add('hide');

      if(!fresh && saved && saved.quizLen===total){
        if(Array.isArray(saved.order) && saved.order.length>0) ORDER = saved.order;
        if(Array.isArray(saved.chosen)) CHOSEN = saved.chosen;
        I = clamp(saved.i,0,Math.max(0,ORDER.length-1));
        FILTER = saved.filter || null;
        if(FILTER) btnClearSearch.classList.remove('hide');
      }

      state.textContent='respondendo';
      show(screenIntro,false); show(screenQuiz,true); show(screenResult,false);
      render();
    }

    function current(){ return QUIZ.questions[ ORDER[I] ]; }

    // ===== Persistência =====
    function persist(){
      const persistFlag=QUIZ?.meta?.persist ?? MANIFEST?.persistDefault ?? true;
      if(!persistFlag||!KEY) return;
      lsSet(KEY.key, {
        i:I,
        chosen:CHOSEN,
        order:ORDER,
        filter:FILTER,
        quizLen: QUIZ.questions.length,
        path: KEY.path,
        ts: Date.now()
      });
      lsSet('quiz:last', KEY);
    }

    // ===== Render =====
    function render(){
      const total=QUIZ.questions.length;
      const answered=ORDER.filter(idx => CHOSEN[idx]!==null).length;
      const denom = ORDER.length || total;
      const progBase = Math.max(1, denom-1);
      bar.style.width = Math.round((I)/progBase*100) + '%';
      footLeft.textContent = `Pergunta ${I+1}/${denom}`;
      footRight.textContent = FILTER
        ? `${answered}/${denom} respondidas · filtro: "${FILTER.term}" (${denom})`
        : `${answered}/${denom} respondidas`;

      const q=current();

      // Título EXATO "<pasta> | <arquivo>"
      const categoryText = QUIZ?.meta?.category || 'Geral';
      const themeText = QUIZ?.meta?.title || 'Quiz';
      questionEl.innerHTML = `
        <div style="font-size: 12px; font-weight: 400; color: var(--muted); text-transform: none; letter-spacing: .2px;">
          ${htmlEscape(categoryText)} | ${htmlEscape(themeText)}
        </div>
        <hr style="border: 0; border-top: 1px solid #e5e7eb; margin: 10px 0;">
        ${q.q}
      `;

      optionsEl.innerHTML='';
      explainEl.classList.add('hide');
      show(btnAI, false);

      const type=q.type||'multiple';
      if(type==='vf'){
        renderOptions(['Verdadeiro','Falso'], (idx)=> select(idx===0), [0,1]);
      } else {
        const opts=q.options.map((t,i)=>({t:i!=null?String(t):'',i}));
        const shOpts = opts; // sem embaralhar perguntas
        renderOptions(shOpts.map(o=>o.t), (idx)=> select(shOpts[idx].i), shOpts.map(o=>o.i));
      }

      btnPrev.disabled = I===0;
      btnNext.textContent = I < denom-1 ? (LABELS.next||'Próximo') : 'Finalizar';

      if (CHOSEN[ ORDER[I] ] !== null) markLocked();

      persist();
    }

    // ===== Opções com etiquetas A, B, C, D =====
    function renderOptions(texts, onPick, origIdxs=null){
      const labels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
      texts.forEach((txt, idx)=>{
        const b=document.createElement('button');
        b.className='opt'; 
        b.dataset.idx=idx; 
        if(origIdxs) b.dataset.origIdx=String(origIdxs[idx]);
        const label = labels[idx] ? `<strong>${labels[idx]})</strong> ` : '';
        // opções são texto simples; encapsula quebras
        const safe = htmlEscape(String(txt||''))
          .replace(/\n{2,}/g,'\n\n')
          .split(/\n{2,}/).map(p=>`<p style="margin:0">${p.replace(/\n/g,'<br>')}</p>`).join('');
        b.innerHTML = `${label}${safe}`;
        b.addEventListener('click', ()=> onPick(idx));
        optionsEl.appendChild(b);
      });
    }

    function isLocked(){ return optionsEl.querySelector('.correct, .wrong') != null; }

    function select(value){
      if(isLocked()) return;
      CHOSEN[ ORDER[I] ] = value;
      toast('Resposta salva','info',1200);
      lockAndExplain(value);
      persist();
    }

    function lockAndExplain(value){
      const q=current(); const type=q.type||'multiple';
      const buttons=Array.from(optionsEl.querySelectorAll('.opt')); buttons.forEach(b=>b.disabled=true);
      let correct=false;
      if(type==='vf'){
        correct = (value === !!q.answer);
        buttons[q.answer ? 0:1].classList.add('correct');
        const chosenIdx=value?0:1; if(!correct) buttons[chosenIdx]?.classList.add('wrong');
      } else {
        const answerIdx=q.answer;
        buttons.forEach(b=>{ const origIdx=parseInt(b.dataset.origIdx??'-1',10); if(origIdx===answerIdx) b.classList.add('correct'); });
        const chosenBtn=buttons.find(b=>parseInt(b.dataset.origIdx??'-1',10)===value);
        correct=(typeof value==='number' && value===answerIdx);
        if(!correct && chosenBtn) chosenBtn.classList.add('wrong');
      }
      state.textContent = correct? 'correto' : 'incorreto';
      toast(correct?'Correto':'Incorreto', correct?'success':'warn',1500);
      explainEl.textContent = q.explanation || '';
      explainEl.classList.toggle('hide', !q.explanation);
      show(btnAI, true);
    }

    function markLocked(){
      const q=current(); const type=q.type||'multiple'; const val=CHOSEN[ ORDER[I] ]; if(val===null) return;
      if(type==='vf'){
        renderOptions(['Verdadeiro','Falso'],()=>{},[0,1]);
      } else {
        const opts=q.options.map((t,i)=>({t,i}));
        const shOpts = opts;
        renderOptions(shOpts.map(o=>o.t), ()=>{}, shOpts.map(o=>o.i));
      }
      lockAndExplain(val);
    }

    function next(){
      if(I < ORDER.length - 1){
        I++;
        render();
      } else {
        finish();
      }
    }

    function prev(){ if(I > 0){ I--; render(); } }

    function score(){
      let ok=0; const total=QUIZ.questions.length;
      for(let k=0;k<total;k++){
        const q=QUIZ.questions[k]; const v=CHOSEN[k];
        if((q.type||'multiple')==='vf'){ if(v===!!q.answer) ok++; }
        else if(typeof v==='number' && v===q.answer) ok++;
      }
      return {ok,total};
    }

    function finish(){
      const {ok,total}=score();
      const pct=Math.round(ok/Math.max(1,total)*100);
      resultScore.textContent=`${pct}% (${ok}/${total})`;
      resultMsg.textContent=QUIZ.meta?.outroMessage || MANIFEST?.outro?.message || '';
      state.textContent='concluído';
      show(screenQuiz,false); show(screenResult,true);
      toast('Você concluiu o quiz','success',2500);
    }

    function openGoogleAI(){
      const q=current(); if(!q) return;
      const prompt = 'VProfessor, por favor fundamente a alternativa correta e as incorretas. Enunciado: ' + String((q && q.q) || '') + ' | Opções: ' + (q && q.type === 'vf' ? 'Verdadeiro | Falso' : (Array.isArray(q && q.options) ? q.options.map(function(t,i){ return (i+1)+') '+t; }).join(' | ') : '')) + ' | Alternativa correta: ' + (q && q.type === 'vf' ? (q && q.answer ? 'Verdadeiro' : 'Falso') : (Array.isArray(q && q.options) && typeof q.answer === 'number' ? q.options[q.answer] : ''));
      const url = 'https://www.google.com/search?udm=50&q=' + encodeURIComponent(prompt.replace(/<[^>]+>/g,''));
      window.open(url, '_blank', 'noopener');
    }

    // ===== Filtro intra-quiz =====
    function applyFilter(termRaw){
      if(!QUIZ){ toast('Carregue um tema antes','warn'); return; }
      const term = String(termRaw||'').trim();
      if(!term){ toast('Informe um termo','warn'); return; }

      const searchTerms = normalizeText(term).split(/\s+/).filter(Boolean);
      if (searchTerms.length === 0) return;

      const hits=[];
      QUIZ.questions.forEach((q,idx)=>{
        const normalizedQ = normalizeText(q.q.replace(/<[^>]+>/g,'') || '');
        const normalizedOpts = (q.options || []).map(o => normalizeText(String(o || '')));

        const allTermsFound = searchTerms.every(st => {
          const regex = new RegExp('\\b' + st + '\\b');
          const inQ = regex.test(normalizedQ);
          const inOpt = normalizedOpts.some(optText => regex.test(optText));
          return inQ || inOpt;
        });

        if (allTermsFound) hits.push(idx);
      });

      if(hits.length===0){ toast('Nada encontrado','warn'); return; }
      ORDER = hits.slice();
      I=0;
      FILTER = { term, size: hits.length };
      btnClearSearch.classList.remove('hide');
      toast(`Filtro aplicado (${hits.length})`,'info');
      render();
    }

    function clearFilter(){
      if(!QUIZ) return;
      ORDER = [...Array(QUIZ.questions.length).keys()];
      FILTER = null;
      btnClearSearch.classList.add('hide');
      I=0;
      toast('Filtro removido','info');
      render();
    }

    // ===== Busca global em TODOS os .txt =====
    async function globalSearchAndOpen(termRaw){
      const term = String(termRaw||'').trim();
      if(!term){ toast('Informe um termo para busca global','warn'); return; }

      const searchTerms = normalizeText(term).split(/\s+/).filter(Boolean);
      if (searchTerms.length === 0) return;

      const allPaths=[];
      (MANIFEST?.categories||[]).forEach(c=>{ (c.themes||[]).forEach(t=> allPaths.push(t.path)); });
      if(allPaths.length===0){ toast('Nenhum tema disponível para busca','error'); return; }

      state.textContent='buscando';
      let results=[];
      for(const p of allPaths){
        try{
          let quizObj = null;
          if(/\.txt$/i.test(p)) quizObj = await loadTxtAsQuiz(p);
          else if(/\.json$/i.test(p)) quizObj = await loadJSON(p);
          if(!quizObj || !Array.isArray(quizObj.questions)) continue;
          quizObj.questions.forEach((q)=>{
            const normalizedQ = normalizeText(String(q.q||'').replace(/<[^>]+>/g,''));
            const normalizedOpts = (q.options || []).map(o => normalizeText(String(o || '')));
            const allTermsFound = searchTerms.every(st => {
              const regex = new RegExp('\\b' + st + '\\b');
              const inQ = regex.test(normalizedQ);
              const inOpt = normalizedOpts.some(optText => regex.test(optText));
              return inQ || inOpt;
            });
            if(allTermsFound){
              const clone = JSON.parse(JSON.stringify(q));
              clone.__origin = { path:p };
              results.push(clone);
            }
          });
        }catch{}
      }

      if(results.length===0){ state.textContent='pronto'; toast('Nada encontrado na busca global','warn',2400); return; }

      const virtual = {
        meta: {
          title: `Busca global: "${term}"`,
          category: 'busca',
          theme: 'global',
          shuffle: {questions:false, options:true},
          persist: true,
          outroMessage: `${results.length} resultados encontrados na busca global.`
        },
        questions: results
      };
      const synth = `search://global?term=${encodeURIComponent(term)}`;
      await loadVirtualQuiz(virtual, synth, true);
      toast(`Busca global: ${results.length} questões`, 'info', 2200);
    }

    // ===== Acessibilidade =====
    window.addEventListener('keydown',(e)=>{
      if(screenQuiz.classList.contains('hide')) return;
      if(e.key>='1'&&e.key<='9'){
        const idx=parseInt(e.key,10)-1; const btn=optionsEl.querySelectorAll('.opt')[idx]; if(btn) btn.click();
      } else if(e.key==='Enter'||e.key==='ArrowRight'){
        if(I===ORDER.length-1) finish(); else next();
      } else if(e.key==='ArrowLeft'){ prev(); }
    });

    window.addEventListener('beforeunload', persist);
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') persist(); });
  </script>

  <!-- Labels padrão -->
  <script type="application/json" data-path="labels/pt-BR.json">{
    "start":"Começar","next":"Próximo","prev":"Anterior","retry":"Refazer","home":"Início","category":"Categoria","theme":"Tema","result":"Resultado"
  }</script>
</body>
</html>
